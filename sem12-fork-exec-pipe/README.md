```python
get_ipython().run_cell_magic('javascript', '', '// setup cpp code highlighting\nIPython.CodeCell.options_default.highlight_modes["text/x-c++src"] = {\'reg\':[/^%%cpp/]} ;')

# creating magics
from IPython.core.magic import register_cell_magic, register_line_magic
from IPython.display import display, Markdown
import argparse

@register_cell_magic
def save_file(args_str, cell, line_comment_start="#"):
    parser = argparse.ArgumentParser()
    parser.add_argument("fname")
    parser.add_argument("--ejudge-style", action="store_true")
    args = parser.parse_args(args_str.split())
    
    cell = cell if cell[-1] == '\n' or args.no_eof_newline else cell + "\n"
    cmds = []
    with open(args.fname, "w") as f:
        f.write(line_comment_start + " %%cpp " + args_str + "\n")
        for line in cell.split("\n"):
            if line.startswith("%"):
                run_prefix = "%run "
                assert line.startswith(run_prefix)
                cmds.append(line[len(run_prefix):].strip())
            else:
                f.write((line if not args.ejudge_style else line.rstrip()) + "\n")
        f.write("" if not args.ejudge_style else line_comment_start + r" line without \n")
    for cmd in cmds:
        display(Markdown("Run: `%s`" % cmd))
        get_ipython().system(cmd)

@register_cell_magic
def cpp(fname, cell):
    save_file(fname, cell, "//")

@register_cell_magic
def asm(fname, cell):
    save_file(fname, cell, "//")
    
@register_cell_magic
def makefile(fname, cell):
    assert not fname
    save_file("makefile", cell.replace(" " * 4, "\t"))
        
@register_line_magic
def p(line):
    try:
        expr, comment = line.split(" #")
        display(Markdown("`{} = {}`  # {}".format(expr.strip(), eval(expr), comment.strip())))
    except:
        display(Markdown("{} = {}".format(line, eval(line))))
    
```


    <IPython.core.display.Javascript object>


# \xd0\xa1\xd0\xb5\xd0\xb3\xd0\xbe\xd0\xb4\xd0\xbd\xd1\x8f \xd0\xb1\xd1\x83\xd0\xb4\xd0\xb5\xd0\xbc \xd0\xb8\xd0\xb7\xd0\xbe\xd0\xb1\xd1\x80\xd0\xb5\xd1\x82\xd0\xb0\xd1\x82\xd1\x8c bash
\xd0\xa7\xd1\x82\xd0\xbe\xd0\xb1\xd1\x8b \xd0\xb4\xd0\xb5\xd0\xbb\xd0\xb0\xd1\x82\xd1\x8c \xd0\xbe\xd1\x81\xd0\xbd\xd0\xbe\xd0\xb2\xd0\xbd\xd1\x83\xd1\x8e \xd0\xbc\xd0\xb0\xd0\xb3\xd0\xb8\xd1\x8e bash \xd0\xbd\xd0\xb0\xd0\xbc \xd0\xbf\xd0\xbe\xd0\xbd\xd0\xb0\xd0\xb4\xd0\xbe\xd0\xb1\xd1\x8f\xd1\x82\xd1\x81\xd1\x8f \xd1\x82\xd1\x80\xd0\xb8 \xd0\xb2\xd1\x8b\xd0\xb7\xd0\xbe\xd0\xb2\xd0\xb0
* `fork` - (\xd0\xbf\xd0\xb5\xd1\x80\xd0\xb5\xd0\xb2\xd0\xbe\xd0\xb4: \xd0\xb2\xd0\xb8\xd0\xbb\xd0\xba\xd0\xb0) \xd0\xbf\xd0\xbe\xd0\xb7\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8f\xd0\xb5\xd1\x82 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81\xd1\x83 \xd1\x80\xd0\xb0\xd0\xb7\xd0\xb4\xd0\xb2\xd0\xbe\xd0\xb8\xd1\x82\xd1\x8c\xd1\x81\xd1\x8f. \xd0\xad\xd1\x82\xd0\xbe \xd0\xb5\xd0\xb4\xd0\xb8\xd0\xbd\xd1\x81\xd1\x82\xd0\xb2\xd0\xb5\xd0\xbd\xd0\xbd\xd1\x8b\xd0\xb9 \xd1\x81\xd0\xbf\xd0\xbe\xd1\x81\xd0\xbe\xd0\xb1 \xd1\x81\xd0\xbe\xd0\xb7\xd0\xb4\xd0\xb0\xd0\xbd\xd0\xb8\xd1\x8f \xd0\xbd\xd0\xbe\xd0\xb2\xd1\x8b\xd1\x85 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81\xd0\xbe\xd0\xb2 \xd0\xb2 linux
* `exec` - \xd0\xbf\xd0\xbe\xd0\xb7\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8f\xd0\xb5\xd1\x82 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81\xd1\x83 \xd0\xb7\xd0\xb0\xd0\xbf\xd1\x83\xd1\x81\xd1\x82\xd0\xb8\xd1\x82\xd1\x8c \xd0\xb4\xd1\x80\xd1\x83\xd0\xb3\xd1\x83\xd1\x8e \xd0\xbf\xd1\x80\xd0\xbe\xd0\xb3\xd1\x80\xd0\xb0\xd0\xbc\xd0\xbc\xd1\x83 \xd0\xb2 \xd1\x81\xd0\xb2\xd0\xbe\xd0\xb5\xd0\xbc \xd1\x82\xd0\xb5\xd0\xbb\xd0\xb5. \xd0\xa2\xd0\xbe \xd0\xb5\xd1\x81\xd1\x82\xd1\x8c \xd0\xbe\xd1\x81\xd1\x82\xd0\xb0\xd0\xb5\xd1\x82\xd1\x81\xd1\x8f \xd1\x82\xd0\xbe\xd1\x82 \xd0\xb6\xd0\xb5 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81 (\xd1\x82\xd0\xbe\xd1\x82 \xd0\xb6\xd0\xb5 pid), \xd1\x82\xd0\xb5 \xd0\xb6\xd0\xb5 \xd0\xbe\xd1\x82\xd0\xba\xd1\x80\xd1\x8b\xd1\x82\xd1\x8b\xd0\xb5 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd1\x8b, \xd0\xb5\xd1\x89\xd0\xb5 \xd1\x87\xd1\x82\xd0\xbe-\xd1\x82\xd0\xbe \xd0\xbe\xd0\xb1\xd1\x89\xd0\xb5\xd0\xb5, \xd0\xbd\xd0\xbe \xd0\xb8\xd1\x81\xd0\xbf\xd0\xbe\xd0\xbb\xd0\xbd\xd1\x8f\xd0\xb5\xd1\x82\xd1\x81\xd1\x8f \xd0\xba\xd0\xbe\xd0\xb4 \xd0\xb8\xd0\xb7 \xd1\x83\xd0\xba\xd0\xb0\xd0\xb7\xd0\xb0\xd0\xbd\xd0\xbd\xd0\xbe\xd0\xb3\xd0\xbe \xd0\xb8\xd1\x81\xd0\xbf\xd0\xbe\xd0\xbb\xd0\xbd\xd1\x8f\xd0\xb5\xd0\xbc\xd0\xbe\xd0\xb3\xd0\xbe \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd0\xb0. \xd0\x9f\xd1\x80\xd1\x8f\xd0\xbc\xd0\xbe \xd0\xbd\xd0\xb0\xd1\x87\xd0\xb8\xd0\xbd\xd0\xb0\xd1\x8f \xd1\x81 \xd1\x84\xd1\x83\xd0\xbd\xd0\xba\xd1\x86\xd0\xb8\xd0\xb8 _start
* `pipe` - \xd0\xbf\xd0\xbe\xd0\xb7\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8f\xd0\xb5\xd1\x82 \xd1\x81\xd0\xbe\xd0\xb7\xd0\xb4\xd0\xb0\xd1\x82\xd1\x8c \xd1\x82\xd1\x80\xd1\x83\xd0\xb1\xd1\x83(=pipe) - \xd0\xbf\xd0\xbe\xd0\xbb\xd1\x83\xd1\x87\xd0\xb8\xd1\x82\xd1\x8c \xd0\xbf\xd0\xb0\xd1\x80\xd1\x83 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd0\xbe\xd0\xb2\xd1\x8b\xd1\x85 \xd0\xb4\xd0\xb5\xd1\x81\xd0\xba\xd1\x80\xd0\xb8\xd0\xbf\xd1\x82\xd0\xbe\xd1\x80\xd0\xbe\xd0\xb2. \xd0\x92 \xd0\xbe\xd0\xb4\xd0\xb8\xd0\xbd \xd0\xb8\xd0\xb7 \xd0\xbd\xd0\xb8\xd1\x85 \xd0\xbc\xd0\xbe\xd0\xb6\xd0\xbd\xd0\xbe \xd1\x87\xd1\x82\xd0\xbe-\xd1\x82\xd0\xbe \xd0\xbf\xd0\xb8\xd1\x81\xd0\xb0\xd1\x82\xd1\x8c, \xd0\xbf\xd1\x80\xd0\xb8 \xd1\x8d\xd1\x82\xd0\xbe\xd0\xbc \xd0\xbe\xd0\xbd\xd0\xbe \xd0\xb1\xd1\x83\xd0\xb4\xd0\xb5\xd1\x82 \xd1\x81\xd1\x82\xd0\xb0\xd0\xbd\xd0\xbe\xd0\xb2\xd0\xb8\xd1\x82\xd1\x8c\xd1\x81\xd1\x8f \xd0\xb4\xd0\xbe\xd1\x81\xd1\x82\xd1\x83\xd0\xbf\xd0\xbd\xd1\x8b\xd0\xbc \xd0\xb4\xd0\xbb\xd1\x8f \xd1\x87\xd1\x82\xd0\xb5\xd0\xbd\xd0\xb8\xd1\x8f \xd0\xb8\xd0\xb7 \xd0\xb4\xd1\x80\xd1\x83\xd0\xb3\xd0\xbe\xd0\xb3\xd0\xbe \xd0\xb4\xd0\xb5\xd1\x81\xd0\xba\xd1\x80\xd0\xb8\xd0\xbf\xd1\x82\xd0\xbe\xd1\x80\xd0\xb0. \xd0\x9c\xd0\xbe\xd0\xb6\xd0\xbd\xd0\xbe \xd1\x80\xd0\xb0\xd1\x81\xd1\x81\xd0\xbc\xd0\xb0\xd1\x82\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb0\xd1\x82\xd1\x8c pipe \xd0\xba\xd0\xb0\xd0\xba \xd1\x81\xd0\xb2\xd0\xbe\xd0\xb5\xd0\xbe\xd0\xb1\xd1\x80\xd0\xb0\xd0\xb7\xd0\xbd\xd1\x8b\xd0\xb9 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb-\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xb5\xd0\xb4\xd1\x8c.
* `dup2` - \xd0\xbf\xd0\xbe\xd0\xb7\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8f\xd0\xb5\xd1\x82 "\xd1\x81\xd0\xba\xd0\xbe\xd0\xbf\xd0\xb8\xd1\x80\xd0\xbe\xd0\xb2\xd0\xb0\xd1\x82\xd1\x8c" \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd0\xbe\xd0\xb2\xd1\x8b\xd0\xb9 \xd0\xb4\xd0\xb5\xd1\x81\xd0\xba\xd1\x80\xd0\xb8\xd0\xbf\xd1\x82\xd0\xbe\xd1\x80. \xd0\xa2\xd0\xbe \xd0\xb5\xd1\x81\xd1\x82\xd1\x8c \xd0\xbf\xd0\xbe\xd0\xbb\xd1\x83\xd1\x87\xd0\xb8\xd1\x82\xd1\x8c \xd0\xb5\xd1\x89\xd0\xb5 \xd0\xbe\xd0\xb4\xd0\xb8\xd0\xbd \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd0\xbe\xd0\xb2\xd1\x8b\xd0\xb9 \xd0\xb4\xd0\xb5\xd1\x81\xd0\xba\xd1\x80\xd0\xb8\xd0\xbf\xd1\x82\xd0\xbe\xd1\x80 \xd0\xbd\xd0\xb0 \xd1\x82\xd0\xbe\xd1\x82 \xd0\xb6\xd0\xb5 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb/\xd1\x81\xd0\xbe\xd0\xb5\xd0\xb4\xd0\xb8\xd0\xbd\xd0\xb5\xd0\xbd\xd0\xb8\xd0\xb5. \xd0\x9d\xd0\xb0\xd0\xbf\xd1\x80\xd0\xb8\xd0\xbc\xd0\xb5\xd1\x80, \xd1\x82\xd0\xb0\xd0\xba \xd0\xbc\xd0\xbe\xd0\xb6\xd0\xbd\xd0\xbe \xd1\x81\xd0\xba\xd0\xbe\xd0\xbf\xd0\xb8\xd1\x80\xd0\xbe\xd0\xb2\xd0\xb0\xd1\x82\xd1\x8c \xd0\xb4\xd0\xb5\xd1\x81\xd0\xba\xd1\x80\xd0\xb8\xd0\xbf\xd1\x82\xd0\xbe\xd1\x80 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd0\xb0 \xd0\xb2 1 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb\xd0\xbe\xd0\xb2\xd1\x8b\xd0\xb9 \xd0\xb4\xd0\xb5\xd1\x81\xd0\xba\xd1\x80\xd0\xb8\xd0\xbf\xd1\x82\xd0\xbe\xd1\x80 \xd0\xb8 \xd0\xbf\xd0\xbe\xd1\x82\xd0\xbe\xd0\xbc \xd1\x81 \xd0\xbf\xd0\xbe\xd0\xbc\xd0\xbe\xd1\x89\xd1\x8c\xd1\x8e \xd1\x84\xd1\x83\xd0\xbd\xd0\xba\xd1\x86\xd0\xb8\xd0\xb8 printf \xd0\xbf\xd0\xb8\xd1\x81\xd0\xb0\xd1\x82\xd1\x8c \xd0\xb2 \xd1\x8d\xd1\x82\xd0\xbe\xd1\x82 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb.

* `wait` - \xd0\xbf\xd1\x80\xd0\xbe\xd0\xb7\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8f\xd0\xb5\xd1\x82 \xd0\xb4\xd0\xbe\xd0\xb6\xd0\xb4\xd0\xb0\xd1\x82\xd1\x8c\xd1\x81\xd1\x8f \xd0\xb4\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xbd\xd0\xb8\xd1\x85 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81\xd0\xbe\xd0\xb2 \xd0\xb8 \xd0\xbf\xd0\xbe\xd0\xbb\xd1\x83\xd1\x87\xd0\xb8\xd1\x82\xd1\x8c \xd0\xb8\xd1\x85 \xd0\xba\xd0\xbe\xd0\xb4 \xd0\xb2\xd0\xbe\xd0\xb7\xd0\xb2\xd1\x80\xd0\xb0\xd1\x82\xd0\xb0. \xd0\xa2\xd0\xb0\xd0\xba \xd0\xb6\xd0\xb5 \xd0\xbf\xd1\x80\xd0\xb5\xd0\xba\xd1\x80\xd0\xb0\xd1\x89\xd0\xb0\xd0\xb5\xd1\x82 \xd0\xb8\xd1\x85 \xd0\xb6\xd0\xb8\xd0\xb7\xd0\xbd\xd1\x8c \xd0\xb2 \xd0\xba\xd0\xb0\xd1\x87\xd0\xb5\xd1\x81\xd1\x82\xd0\xb2\xd0\xb5 \xd0\xb7\xd0\xbe\xd0\xbc\xd0\xb1\xd0\xb8.

\xd0\x98\xd0\xb7\xd0\xbe\xd0\xb1\xd1\x80\xd0\xb5\xd1\x82\xd0\xb0\xd1\x82\xd1\x8c \xd0\xb1\xd1\x83\xd0\xb4\xd0\xb5\xd1\x82 \xd1\x82\xd0\xb0\xd0\xba\xd1\x83\xd1\x8e \xd0\xbc\xd0\xb0\xd0\xb3\xd0\xb8\xd1\x8e:
* \xd0\x97\xd0\xb0\xd0\xbf\xd1\x83\xd1\x81\xd0\xba \xd1\x81\xd1\x82\xd0\xbe\xd1\x80\xd0\xbe\xd0\xbd\xd0\xbd\xd0\xb5\xd0\xb9 \xd0\xbf\xd1\x80\xd0\xbe\xd0\xb3\xd1\x80\xd0\xb0\xd0\xbc\xd0\xbc\xd1\x8b
* `./program arg1 arg2 > out.txt` \xd1\x82\xd0\xbe \xd0\xb5\xd1\x81\xd1\x82\xd1\x8c \xd0\xbe\xd0\xbf\xd0\xb5\xd1\x80\xd0\xb0\xd1\x82\xd0\xbe\xd1\x80 `>` \xd0\xb8\xd0\xb7 bash
* `./program1 arg1_1 arg1_2 | ./program2 arg2_1 arg2_2` \xd1\x82\xd0\xbe \xd0\xb5\xd1\x81\xd1\x82\xd1\x8c \xd0\xbe\xd0\xbf\xd0\xb5\xd1\x80\xd0\xb0\xd1\x82\xd0\xbe\xd1\x80 `|` \xd0\xb8\xd0\xb7 bash


# fork

`man fork`, `man waitpid`

\xd0\x9f\xd1\x80\xd0\xbe\xd1\x81\xd1\x82\xd0\xb5\xd0\xb9\xd1\x88\xd0\xb8\xd0\xb9 \xd0\xbf\xd1\x80\xd0\xb8\xd0\xbc\xd0\xb5\xd1\x80: \xd0\xba\xd0\xbb\xd0\xbe\xd0\xbd\xd0\xb8\xd1\x80\xd1\x83\xd0\xb5\xd0\xbc \xd1\x81\xd0\xb5\xd0\xb1\xd1\x8f, \xd0\xb8 \xd0\xb2 \xd0\xbe\xd1\x80\xd0\xb8\xd0\xb3\xd0\xb8\xd0\xbd\xd0\xb0\xd0\xbb\xd0\xb5 \xd0\xb4\xd0\xbe\xd0\xb6\xd0\xb8\xd0\xb4\xd0\xb0\xd0\xb5\xd0\xbc\xd1\x81\xd1\x8f, \xd0\xbf\xd0\xbe\xd0\xba\xd0\xb0 \xd0\xba\xd0\xbe\xd0\xbf\xd0\xb8\xd1\x8f \xd0\xb7\xd0\xb0\xd0\xb2\xd0\xb5\xd1\x80\xd1\x88\xd0\xb8\xd1\x82\xd1\x81\xd1\x8f, \xd0\xbf\xd0\xbe\xd1\x82\xd0\xbe\xd0\xbc \xd1\x82\xd0\xbe\xd0\xb6\xd0\xb5 \xd0\xb7\xd0\xb0\xd0\xb2\xd0\xb5\xd1\x80\xd1\x88\xd0\xb0\xd0\xb5\xd0\xbc\xd1\x81\xd1\x8f.


```python
%%cpp simpliest_example.cpp
%run gcc simpliest_example.cpp -o simpliest_example.exe
%run ./simpliest_example.exe

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <sys/wait.h>
#include <sched.h>

int main() {
    pid_t pid = fork();
//     if (pid != 0) {
//         for (int i = 0; i < 1000000; ++i) {
//             sched_yield();
//         }
//     }
    printf("Hello world! fork result (child pid) = %d, own pid = %d\n", pid, getpid()); // \xd0\xb2\xd1\x8b\xd0\xbf\xd0\xbe\xd0\xbb\xd0\xbd\xd0\xb8\xd1\x82\xd1\x81\xd1\x8f \xd0\xb8 \xd0\xb2 \xd1\x80\xd0\xbe\xd0\xb4\xd0\xb8\xd1\x82\xd0\xb5\xd0\xbb\xd0\xb5 \xd0\xb8 \xd0\xb2 \xd1\x80\xd0\xb5\xd0\xb1\xd0\xb5\xd0\xbd\xd0\xba\xd0\xb5
    
    if (pid == 0) {
        return 42; // \xd0\xb5\xd1\x81\xd0\xbb\xd0\xb8 \xd1\x8d\xd1\x82\xd0\xbe \xd0\xb4\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xbd\xd0\xb8\xd0\xb9 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81, \xd1\x82\xd0\xbe \xd0\xb7\xd0\xb0\xd0\xb2\xd0\xb5\xd1\x80\xd1\x88\xd0\xb0\xd0\xb5\xd0\xbc\xd1\x81\xd1\x8f
    }
    int status;
    pid_t w = waitpid(pid, &status, 0); // \xd0\xbe\xd0\xb1\xd1\x8f\xd0\xb7\xd0\xb0\xd1\x82\xd0\xb5\xd0\xbb\xd1\x8c\xd0\xbd\xd0\xbe \xd0\xbd\xd1\x83\xd0\xb6\xd0\xbd\xd0\xbe \xd0\xb4\xd0\xbe\xd0\xb6\xd0\xb4\xd0\xb0\xd1\x82\xd1\x8c\xd1\x81\xd1\x8f, \xd0\xbf\xd0\xbe\xd0\xba\xd0\xb0 \xd0\xb7\xd0\xb0\xd0\xb2\xd0\xb5\xd1\x80\xd1\x88\xd0\xb8\xd1\x82\xd1\x81\xd1\x8f \xd0\xb4\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xbd\xd0\xb8\xd0\xb9 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81
    if (w == -1) {
        perror("waitpid");
        exit(-1);
    }
    assert(WIFEXITED(status));
    printf("Child exited with code %d\n", WEXITSTATUS(status)); // \xd0\xb2\xd1\x8b\xd0\xb2\xd0\xbe\xd0\xb4\xd0\xb8\xd0\xbc \xd0\xba\xd0\xbe\xd0\xb4 \xd0\xb2\xd0\xbe\xd0\xb7\xd0\xb2\xd1\x80\xd0\xb0\xd1\x82\xd0\xb0 \xd0\xb4\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xbd\xd0\xb5\xd0\xb3\xd0\xbe \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81\xd0\xb0
    return 0;
}
```


Run: `gcc simpliest_example.cpp -o simpliest_example.exe`



Run: `./simpliest_example.exe`


    Hello world! fork result (child pid) = 30385, own pid = 30384
    Hello world! fork result (child pid) = 0, own pid = 30385
    Child exited with code 42



```python

```

# fork + exec

`man exec`, `man wait4`

\xd0\x9e \xd1\x82\xd0\xbe\xd0\xbc \xd0\xba\xd0\xb0\xd0\xba \xd0\xb3\xd1\x83\xd0\xb3\xd0\xbb\xd0\xb8\xd1\x82\xd1\x8c \xd0\xbd\xd0\xb5\xd0\xbf\xd0\xbe\xd0\xbd\xd1\x8f\xd1\x82\xd0\xbd\xd1\x8b\xd0\xb5 \xd1\x81\xd1\x82\xd1\x80\xd1\x83\xd0\xba\xd1\x82\xd1\x83\xd1\x80\xd1\x8b: struct timeval linux 


```python
%%cpp fork_exec.cpp
%run gcc fork_exec.cpp -o fork_exec.exe
%run ./fork_exec.exe

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include\xc2\xa0<assert.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>


int main() {
    pid_t pid;
    if ((pid = fork()) == 0) {
        //execlp("ps", "ps", "aux", NULL); // also possible variant
        //execlp("echo", "echo", "Hello world from linux ECHO program", NULL);
        //execlp("sleep", "sleep", "3", NULL);
        execlp("bash", "bash", "-c", "ps aux | head -n 4", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    int status;
    struct rusage resource_usage;
    pid_t w = wait4(pid, &status, 0, &resource_usage); // \xd0\xbe\xd0\xb1\xd1\x8f\xd0\xb7\xd0\xb0\xd1\x82\xd0\xb5\xd0\xbb\xd1\x8c\xd0\xbd\xd0\xbe \xd0\xbd\xd1\x83\xd0\xb6\xd0\xbd\xd0\xbe \xd0\xb4\xd0\xbe\xd0\xb6\xd0\xb4\xd0\xb0\xd1\x82\xd1\x8c\xd1\x81\xd1\x8f, \xd0\xbf\xd0\xbe\xd0\xba\xd0\xb0 \xd0\xb7\xd0\xb0\xd0\xb2\xd0\xb5\xd1\x80\xd1\x88\xd0\xb8\xd1\x82\xd1\x81\xd1\x8f \xd0\xb4\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xbd\xd0\xb8\xd0\xb9 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81
    if (w == -1) {
        perror("waitpid");
        exit(-1);
    }
    assert(WIFEXITED(status));
    printf("Child exited with code %d \n"
           "\tUser time %ld sec %ld usec\n"
           "\tSys time %ld sec %ld usec\n", 
           WEXITSTATUS(status), 
           resource_usage.ru_utime.tv_sec,
           resource_usage.ru_utime.tv_usec,
           resource_usage.ru_stime.tv_sec,
           resource_usage.ru_stime.tv_usec); // \xd0\xb2\xd1\x8b\xd0\xb2\xd0\xbe\xd0\xb4\xd0\xb8\xd0\xbc \xd0\xba\xd0\xbe\xd0\xb4 \xd0\xb2\xd0\xbe\xd0\xb7\xd0\xb2\xd1\x80\xd0\xb0\xd1\x82\xd0\xb0 \xd0\xb4\xd0\xbe\xd1\x87\xd0\xb5\xd1\x80\xd0\xbd\xd0\xb5\xd0\xb3\xd0\xbe \xd0\xbf\xd1\x80\xd0\xbe\xd1\x86\xd0\xb5\xd1\x81\xd1\x81\xd0\xb0 + \xd0\xb5\xd1\x89\xd0\xb5 \xd0\xbf\xd0\xbe\xd0\xbb\xd0\xb5\xd0\xb7\xd0\xbd\xd1\x83\xd1\x8e \xd0\xb8\xd0\xbd\xd1\x84\xd0\xbe\xd1\x80\xd0\xbc\xd0\xb0\xd1\x86\xd0\xb8\xd1\x8e
    
    return 0;
}
```


Run: `gcc fork_exec.cpp -o fork_exec.exe`



Run: `./fork_exec.exe`


    USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root         1  0.0  0.1 119740  3864 ?        Ss   \xd0\xbd\xd0\xbe\xd1\x8f11   0:14 /sbin/init splash
    root         2  0.0  0.0      0     0 ?        S    \xd0\xbd\xd0\xbe\xd1\x8f11   0:00 [kthreadd]
    root         4  0.0  0.0      0     0 ?        I<   \xd0\xbd\xd0\xbe\xd1\x8f11   0:00 [kworker/0:0H]
    Child exited with code 0 
    	User time 0 sec 5849 usec
    	Sys time 0 sec 6650 usec



```python

```

# dup2

\xd0\x92\xd0\xbe\xd0\xb7\xd0\xbc\xd0\xbe\xd0\xb6\xd0\xbd\xd0\xbe \xd0\xba\xd1\x82\xd0\xbe-\xd1\x82\xd0\xbe \xd0\xb8\xd0\xb7 \xd0\xb2\xd0\xb0\xd1\x81 \xd0\xb2\xd0\xb8\xd0\xb4\xd0\xb5\xd0\xbb \xd0\xb2\xd1\x8b\xd0\xb7\xd0\xbe\xd0\xb2 freopen. \xd0\x92\xd0\xbe\xd1\x82 \xd1\x8d\xd1\x82\xd0\xbe \xd0\xbf\xd1\x80\xd0\xb8\xd0\xbc\xd0\xb5\xd1\x80\xd0\xbd\xd0\xbe \xd0\xbe \xd1\x82\xd0\xbe\xd0\xbc \xd0\xb6\xd0\xb5.


```python
%%cpp fork_exec_pipe.cpp
%run gcc fork_exec_pipe.cpp -o fork_exec_pipe.exe
%run ./fork_exec_pipe.exe
%run echo "After program finish" && cat out.txt

#include <stdio.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/types.h>


int main() {
    int fd = open("out.txt", O_WRONLY | O_CREAT | O_TRUNC, 0664);
    dup2(fd, 1); // redirect stdout to file
    close(fd);
    printf("Redirectred 'Hello world!'");
    return 0;
}
```


Run: `gcc fork_exec_pipe.cpp -o fork_exec_pipe.exe`



Run: `./fork_exec_pipe.exe`



Run: `echo "After program finish" && cat out.txt`


    After program finish
    Redirectred 'Hello world!'

# fork + exec + dup2
\xd0\xa0\xd0\xb5\xd0\xb0\xd0\xbb\xd0\xb8\xd0\xb7\xd1\x83\xd0\xb5\xd0\xbc \xd0\xbf\xd0\xb5\xd1\x80\xd0\xb5\xd0\xbd\xd0\xb0\xd0\xbf\xd1\x80\xd0\xb0\xd0\xb2\xd0\xbb\xd0\xb5\xd0\xbd\xd0\xb8\xd0\xb5 \xd0\xb2\xd1\x8b\xd0\xb2\xd0\xbe\xd0\xb4\xd0\xb0 \xd0\xbf\xd1\x80\xd0\xbe\xd0\xb3\xd1\x80\xd0\xb0\xd0\xbc\xd0\xbc\xd1\x8b \xd0\xb2 \xd1\x84\xd0\xb0\xd0\xb9\xd0\xbb. (\xd0\x9e\xd0\xbf\xd0\xb5\xd1\x80\xd0\xb0\xd1\x82\xd0\xbe\xd1\x80 `>` \xd0\xb8\xd0\xb7 bash)


```python
%%cpp redirect.cpp
%run gcc redirect.cpp -o redirect.exe
%run ./redirect.exe out.txt   ps aux
%run cat out.txt | head -n 2

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>


int main(int argc, char** argv) {
    assert(argc >= 2);
    int fd = open(argv[1], O_WRONLY | O_CREAT | O_TRUNC, 0664);
    assert(fd >= 0);
    dup2(fd, 1);
    close(fd);
    execvp(argv[2], argv + 2);
    assert(0 && "Unreachable position in code if execlp succeeded");
}
```


Run: `gcc redirect.cpp -o redirect.exe`



Run: `./redirect.exe out.txt   ps aux`



Run: `cat out.txt | head -n 2`


    USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root         1  0.0  0.1 119740  3864 ?        Ss   \xd0\xbd\xd0\xbe\xd1\x8f11   0:14 /sbin/init splash


# fork + exec + pipe + dup2

`man 2 pipe`, `man dup2`

\xd0\xa0\xd0\xb5\xd0\xb0\xd0\xbb\xd0\xb8\xd0\xb7\xd1\x83\xd0\xb5\xd0\xbc \xd0\xbb\xd0\xbe\xd0\xb3\xd0\xb8\xd0\xba\xd1\x83 \xd0\xbf\xd0\xb0\xd0\xb9\xd0\xbf\xd0\xb0 / \xd0\xbe\xd0\xbf\xd0\xb5\xd1\x80\xd0\xb0\xd1\x82\xd0\xbe\xd1\x80\xd0\xb0 `|` \xd0\xb8\xd0\xb7 bash: \xd0\xb7\xd0\xb0\xd0\xbf\xd1\x83\xd1\x81\xd0\xba \xd0\xb4\xd0\xb2\xd1\x83\xd1\x85 \xd0\xbf\xd1\x80\xd0\xbe\xd0\xb3\xd1\x80\xd0\xb0\xd0\xbc\xd0\xbc \xd0\xb8 \xd0\xbf\xd0\xb5\xd1\x80\xd0\xb5\xd0\xbd\xd0\xb0\xd0\xbf\xd1\x80\xd0\xb0\xd0\xb2\xd0\xbb\xd0\xb5\xd0\xbd\xd0\xb8\xd0\xb5 \xd0\xb2\xd1\x8b\xd0\xb2\xd0\xbe\xd0\xb4\xd0\xb0 \xd0\xbe\xd0\xb4\xd0\xbd\xd0\xbe\xd0\xb9 \xd0\xbd\xd0\xb0 \xd0\xb2\xd0\xb2\xd0\xbe\xd0\xb4 \xd0\xb4\xd1\x80\xd1\x83\xd0\xb3\xd0\xbe\xd0\xb9.


```python
%%cpp fork_exec_pipe.cpp
%run gcc fork_exec_pipe.cpp -o fork_exec_pipe.exe
%run ./fork_exec_pipe.exe

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <fcntl.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>


int main() {
    int fd[2];
    pipe(fd); // fd[0] - in, fd[1] - out (like stdin=0, stdout=1)
    pid_t pid_1, pid_2;
    if ((pid_1 = fork()) == 0) {
        dup2(fd[1], 1);
        close(fd[0]);
        close(fd[1]);
        execlp("ps", "ps", "aux", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    if ((pid_2 = fork()) == 0) {
        dup2(fd[0], 0);
        close(fd[0]);
        close(fd[1]);
        execlp("head", "head", "-n", "4", NULL);
        assert(0 && "Unreachable position in code if execlp succeeded");
    }
    close(fd[0]);
    close(fd[1]);
    int status;
    assert(waitpid(pid_1, &status, 0) != -1);
    assert(waitpid(pid_2, &status, 0) != -1);
    return 0;
}
```


Run: `gcc fork_exec_pipe.cpp -o fork_exec_pipe.exe`



Run: `./fork_exec_pipe.exe`


    USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root         1  0.0  0.1 119740  3864 ?        Ss   \xd0\xbd\xd0\xbe\xd1\x8f11   0:14 /sbin/init splash
    root         2  0.0  0.0      0     0 ?        S    \xd0\xbd\xd0\xbe\xd1\x8f11   0:00 [kthreadd]
    root         4  0.0  0.0      0     0 ?        I<   \xd0\xbd\xd0\xbe\xd1\x8f11   0:00 [kworker/0:0H]



```python
!man dup2
```

    DUP(2)                     Linux Programmer's Manual                    DUP(2)
    
    NNAAMMEE
           dup, dup2, dup3 - duplicate a file descriptor
    
    SSYYNNOOPPSSIISS
           ##iinncclluuddee <<uunniissttdd..hh>>
    
           iinntt dduupp((iinntt _o_l_d_f_d));;
           iinntt dduupp22((iinntt _o_l_d_f_d,, iinntt _n_e_w_f_d));;
    
           ##ddeeffiinnee __GGNNUU__SSOOUURRCCEE             /* See feature_test_macros(7) */
           ##iinncclluuddee <<ffccnnttll..hh>>              /* Obtain O_* constant definitions */
           ##iinncclluuddee <<uunniissttdd..hh>>
    
           iinntt dduupp33((iinntt _o_l_d_f_d,, iinntt _n_e_w_f_d,, iinntt _f_l_a_g_s));;
    
    DDEESSCCRRIIPPTTIIOONN
           The  dduupp()  system  call  creates  a copy of the file descriptor _o_l_d_f_d,
           using the lowest-numbered unused descriptor for the new descriptor.
    
           After a successful return, the old and new file descriptors may be used
           interchangeably.   They  refer  to  the same open file description (see
           ooppeenn(2)) and thus share file offset and file status flags; for example,
           if the file offset is modified by using llsseeeekk(2) on one of the descrip\xe2\x80\x90
           tors, the offset is also changed for the other.
    
           The two descriptors do not share file descriptor flags  (the  close-on-
           exec  flag).  The close-on-exec flag (FFDD__CCLLOOEEXXEECC; see ffccnnttll(2)) for the
           duplicate descriptor is off.
    
       dduupp22(())
           The dduupp22() system call performs the same task as dduupp(), but instead  of
           using  the lowest-numbered unused file descriptor, it uses the descrip\xe2\x80\x90
           tor number specified in _n_e_w_f_d.  If the descriptor _n_e_w_f_d was  previously
           open, it is silently closed before being reused.
    
           The  steps  of  closing  and reusing the file descriptor _n_e_w_f_d are per\xe2\x80\x90
           formed _a_t_o_m_i_c_a_l_l_y.  This is  important,  because  trying  to  implement
           equivalent  functionality  using cclloossee(2) and dduupp() would be subject to
           race conditions, whereby _n_e_w_f_d might be reused between the  two  steps.
           Such  reuse  could  happen because the main program is interrupted by a
           signal handler that allocates a file descriptor, or because a  parallel
           thread allocates a file descriptor.
    
           Note the following points:
    
           *  If  _o_l_d_f_d  is  not a valid file descriptor, then the call fails, and
              _n_e_w_f_d is not closed.
    
           *  If _o_l_d_f_d is a valid file descriptor, and _n_e_w_f_d has the same value as
              _o_l_d_f_d, then dduupp22() does nothing, and returns _n_e_w_f_d.
    
       dduupp33(())
           dduupp33() is the same as dduupp22(), except that:
    
           *  The  caller  can  force the close-on-exec flag to be set for the new
              file descriptor by specifying OO__CCLLOOEEXXEECC in _f_l_a_g_s.  See the  descrip\xe2\x80\x90
              tion of the same flag in ooppeenn(2) for reasons why this may be useful.
    
           *  If _o_l_d_f_d equals _n_e_w_f_d, then dduupp33() fails with the error EEIINNVVAALL.
    
    RREETTUURRNN VVAALLUUEE
           On success, these system calls return the new descriptor.  On error, -1
           is returned, and _e_r_r_n_o is set appropriately.
    
    EERRRROORRSS
           EEBBAADDFF  _o_l_d_f_d isn't an open file descriptor.
    
           EEBBAADDFF  _n_e_w_f_d is out of the allowed range for file descriptors (see  the
                  discussion of RRLLIIMMIITT__NNOOFFIILLEE in ggeettrrlliimmiitt(2)).
    
           EEBBUUSSYY  (Linux  only)  This may be returned by dduupp22() or dduupp33() during a
                  race condition with ooppeenn(2) and dduupp().
    
           EEIINNTTRR  The dduupp22() or dduupp33() call was interrupted by a signal; see  ssiigg\xe2\x80\x90\xe2\x80\x90
                  nnaall(7).
    
           EEIINNVVAALL (dduupp33()) _f_l_a_g_s contain an invalid value.
    
           EEIINNVVAALL (dduupp33()) _o_l_d_f_d was equal to _n_e_w_f_d.
    
           EEMMFFIILLEE The per-process limit on the number of open file descriptors has
                  been reached (see  the  discussion  of  RRLLIIMMIITT__NNOOFFIILLEE  in  ggeettrr\xe2\x80\x90\xe2\x80\x90
                  lliimmiitt(2)).
    
    VVEERRSSIIOONNSS
           dduupp33() was added to Linux in version 2.6.27; glibc support is available
           starting with version 2.9.
    
    CCOONNFFOORRMMIINNGG TTOO
           dduupp(), dduupp22(): POSIX.1-2001, POSIX.1-2008, SVr4, 4.3BSD.
    
           dduupp33() is Linux-specific.
    
    NNOOTTEESS
           The error returned  by  dduupp22()  is  different  from  that  returned  by
           ffccnnttll((..., FF__DDUUPPFFDD, ...))  when _n_e_w_f_d is out of range.  On some systems,
           dduupp22() also sometimes returns EEIINNVVAALL like FF__DDUUPPFFDD.
    
           If _n_e_w_f_d was open, any errors that would have been reported at cclloossee(2)
           time  are lost.  If this is of concern, then\xe2\x80\x94unless the program is sin\xe2\x80\x90
           gle-threaded and does not allocate file descriptors in signal handlers\xe2\x80\x94
           the  correct  approach  is  _n_o_t  to  close _n_e_w_f_d before calling dduupp22(),
           because of the race condition described above.  Instead, code something
           like the following could be used:
    
               /* Obtain a duplicate of 'newfd' that can subsequently
                  be used to check for close() errors; an EBADF error
                  means that 'newfd' was not open. */
    
               tmpfd = dup(newfd);
               if (tmpfd == -1 && errno != EBADF) {
                   /* Handle unexpected dup() error */
               }
    
               /* Atomically duplicate 'oldfd' on 'newfd' */
    
               if (dup2(oldfd, newfd) == -1) {
                   /* Handle dup2() error */
               }
    
               /* Now check for close() errors on the file originally
                  referred to by 'newfd' */
    
               if (tmpfd != -1) {
                   if (close(tmpfd) == -1) {
                       /* Handle errors from close */
                   }
               }
    
    SSEEEE AALLSSOO
           cclloossee(2), ffccnnttll(2), ooppeenn(2)
    
    CCOOLLOOPPHHOONN
           This  page  is  part of release 4.04 of the Linux _m_a_n_-_p_a_g_e_s project.  A
           description of the project, information about reporting bugs,  and  the
           latest     version     of     this    page,    can    be    found    at
           http://www.kernel.org/doc/man-pages/.
    
    Linux                             2015-12-28                            DUP(2)


# inf09-0

```
sudo useradd tmp_user
sudo passwd tmp_user
su tmp_user
ulimit -u 100
./inf09_0.exe
```


```python
%%cpp inf09_0.c --ejudge-style
%run gcc inf09_0.c -o inf09_0.exe

#include <assert.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/resource.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

int main()
{
    for (int i = 1; 1; ++i) {
        int pid = fork();
        fflush(stdout);
        if (pid < 0) {
            printf("%d\n", i);
            return 0;
        }
        if (pid != 0) {
            int status;
            assert(waitpid(pid, &status, 0) != -1);
            break;
        }
    }
    return 0;
}
```


Run: `gcc inf09_0.c -o inf09_0.exe`



```python
!cat inf09_0.c
```

    // %%cpp inf09_0.c --ejudge-style
    
    #include <assert.h>
    #include <fcntl.h>
    #include <stdio.h>
    #include <stdlib.h>
    #include <sys/resource.h>
    #include <sys/types.h>
    #include <sys/wait.h>
    #include <unistd.h>
    
    int main()
    {
        for (int i = 1; 1; ++i) {
            int pid = fork();
            fflush(stdout);
            if (pid < 0) {
                printf("%d\n", i);
                return 0;
            }
            if (pid != 0) {
                int status;
                assert(waitpid(pid, &status, 0) != -1);
                break;
            }
        }
        return 0;
    }
    
    // line without \n


```python

```
